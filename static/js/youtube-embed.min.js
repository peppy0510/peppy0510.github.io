function createElement(tag,className,value){let element=document.createElement(tag);if(className){element.className=className;}
if(value){element.appendChild(document.createTextNode(value));}
return element;}
async function loadYoutubeAPI(){let containers=$('.youtube-video-container');if(!containers.length)return;const tag=document.createElement('script');tag.src='https://www.youtube.com/iframe_api';const firstScriptTag=document.getElementsByTagName('script')[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);}
let youtubeIds=[];let youtubePlayers=[];let youtubeContainers=[];const youtubeIntersectionObserver=new IntersectionObserver(onIntersectionYoutube,{threshold:0,});function onPlayerReady(event){}
function getNextVideoId(videoId){let nextId=undefined;for(let index=0;index<youtubeIds.length;index++){if(youtubeIds[index]!==videoId)continue;nextId=youtubeIds[index+1];break;}
return nextId;}
let youtubePlayerTimeout=undefined;function onPlayerStateChange(event){const target=event.target;if(!target||!target.playerInfo||!target.playerInfo.videoData)return;const videoId=target.playerInfo.videoData.video_id;const nextVideoId=getNextVideoId(videoId);if(event.data===YT.PlayerState.PLAYING){for(let index=0;index<youtubePlayers.length;index++){const player=youtubePlayers[index];if(!player||!player.playerInfo||!player.playerInfo.videoData)continue;const _videoId=player.playerInfo.videoData.video_id;if(_videoId===videoId)continue;if(!player.pauseVideo)continue;player.pauseVideo();}
loadYoutubeVideoId(nextVideoId);}else if(event.data===YT.PlayerState.ENDED){for(let index=0;index<youtubePlayers.length;index++){const player=youtubePlayers[index];if(!player||!player.playerInfo||!player.playerInfo.videoData)continue;if(player.playerInfo.videoData.video_id!==videoId)continue;if(!player.seekTo)continue;player.seekTo(0);player.stopVideo();break;}
clearTimeout(youtubePlayerTimeout);youtubePlayerTimeout=setTimeout(()=>{for(let index=0;index<youtubePlayers.length;index++){const player=youtubePlayers[index];if(!player||!player.playerInfo||!player.playerInfo.videoData)continue;if(player.playerInfo.videoData.video_id!==nextVideoId)continue;if(!player.playVideo)continue;player.seekTo(0);player.playVideo();break;}},100);}}
function onPlayerError(event){}
function loadYoutubeVideoId(videoId){const origin=window.location.origin;const player=new window.YT.Player(`youtube-source-${videoId}`,{height:'560',width:'315',videoId:videoId,playerVars:{loop:1,autoplay:0,controls:1,playsinline:1,enablejsapi:1,modestbranding:1,origin:origin,},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange,onError:onPlayerError,},});youtubePlayers.push(player);}
async function onIntersectionYoutube(entries,observer){for(let index=0;index<entries.length;index++){if(!entries[index].isIntersecting||entries[index].isVisible)continue;const source=entries[index].target.getAttribute('youtube-source');const iframe=entries[index].target.querySelector('div.youtube-video-iframe');if(!iframe)continue;loadYoutubeVideoId(source);}}
function initializeYoutubeEmbed(){let youtubes=$('youtube');for(let i=0;i<youtubes.length;i++){let hash=undefined;for(let ii=0;ii<youtubes[i].attributes.length;ii++){if(youtubes[i].attributes[ii].name==='source'){hash=youtubes[i].attributes[ii].value;}}
if(!hash){continue;}
let title=youtubes[i].innerText;if(title){title=createElement('h4','',youtubes[i].innerText);}
let wrapper=createElement('div','fluid-width-video-wrapper');let container=createElement('div','video-container');container.classList.add('youtube-video-container');container.setAttribute('youtube-source',hash);youtubeIds.push(hash);let iframe=createElement('div','youtube-video-iframe');iframe.setAttribute('youtube-source',hash);iframe.setAttribute('id',`youtube-source-${hash}`);youtubeContainers.push(container);container.appendChild(iframe);wrapper.appendChild(container);youtubes[i].parentNode.after(createElement('p'));youtubes[i].parentNode.before(createElement('p'));if(title){youtubes[i].parentNode.before(title);}
youtubes[i].parentNode.replaceWith(wrapper);}
}
async function onYouTubeIframeAPIReady(){for(let index=0;index<youtubeContainers.length;index++){youtubeIntersectionObserver.observe(youtubeContainers[index]);}
}
$(document).ready(async function(){initializeYoutubeEmbed();loadYoutubeAPI();});